@{
    ViewBag.Title = "Chat";
}
<div class="container" style="display:inline-block; width:70%">
    <img src="~/Content/Images/images.jpg" style="width: 50px;margin-left:35px;display: inline-block;" /><h2 style="display: inline-block;vertical-align: bottom;">Chat</h2>
    <input type="hidden" id="username" />

    <ul id="chatboard" style="max-height:400px;overflow-y:scroll">
        @foreach (var userchat in ViewBag.Messages)
        {
            // Add the message to the page.
            if (@userchat.User.UserName == ViewBag.UserName)
            {
                <li class="currentUser">
                    <div class="message" style="text-align:right">
                        <img src="~/Content/Images/user_blank.png" width="20" />
                        <strong style="vertical-align:bottom">
                            @userchat.User.UserName
                        </strong>
                        <br />
                        <div style="margin-top: 5px;">@userchat.Message </div>
                        <span>
                            @if (@userchat.MessageDateTime.ToLocalTime().ToString().Contains(DateTime.Today.ToShortDateString()))
                            {
                                @userchat.MessageDateTime.ToLocalTime().ToShortTimeString()
                            }
                            else
                            {
                                @userchat.MessageDateTime.ToLocalTime().ToLongDateString()<span> &nbsp; </span>
                                @userchat.MessageDateTime.ToLocalTime().ToShortTimeString()
                            }
                        </span>
                    </div>
                </li> }
            else
            {
                <li>
                    <div class="message">
                        <img src="~/Content/Images/user_blank.png" width="20" />
                        <strong style="vertical-align:bottom">
                            @userchat.User.UserName
                        </strong> <br />
                        <div style="margin-top: 5px;">@userchat.Message </div>
                        <span>
                            @if (@userchat.MessageDateTime.ToLocalTime().ToString().Contains(DateTime.Today.ToShortDateString()))
                            {

                                @userchat.MessageDateTime.ToLocalTime().ToShortTimeString()
                            }
                            else
                            {
                                @userchat.MessageDateTime.ToLocalTime().ToLongDateString() <span>  </span>
                                @userchat.MessageDateTime.ToLocalTime().ToShortTimeString()
                            }
                        </span>
                    </div>

                </li> }

        }
    </ul>

    <ul>
        <li>

            <textarea id="message"></textarea>
            <input type="button" id="sendmessage" value="Send" />
        </li>
    </ul>
    <p id="typing" style="margin-left:45px;margin-top:0"></p>
</div>

<div class="onlineUsers" style="display:inline-block;width:29%;vertical-align:top">
    <h2 style="margin-left: 35px;">Online Users</h2>
    <ul id="onlineUsers" style="width:100%"></ul>
</div>
@section scripts {
    <!--Script references. -->
    <script src="~/Scripts/enums.js"></script>
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {

            // Scroll the div to end.
            $("#chatboard").scrollTop($('#chatboard')[0].scrollHeight)
            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.signalRChatHub;
            // Create a function that the hub can call back to display messages.
            chat.client.addNewMessageToPage = function (name, message) {
                // Add the message to the page.
                if (name == "@ViewBag.UserName") {
                    $('#chatboard').append('<li class="currentUser">  <div class="message" style="text-align: right;"><img src="../Content/Images/user_blank.png" width="20" /><strong >' + htmlEncode(name)
                       + '</strong><br /><div> ' + message + '</div><span> ' + getFormatedDate(new Date()) + '</span></div></li>');
                }
                else {
                    $('#chatboard').append('<li>  <div class="message"><img src="../Content/Images/user_blank.png" width="20" /><strong >' + htmlEncode(name)
                        + '</strong><br /><div> ' + message + '</div><span> ' + getFormatedDate(new Date()) + '</span></div></li>');

                }
                $("#chatboard").scrollTop($('#chatboard')[0].scrollHeight)
            };
            chat.client.joinedRoom = function (onlineUsers, newUser) {
                var html = "";
                onlineUsers.forEach(function (name) {
                    html += '<li>' + name.UserName + '<span>joined at ' + name.ConnectionDateTime + '</span></li>';
                })

                $("#onlineUsers").html(html)
                if (newUser != null || newUser != undefined) {
                    var name = "@ViewBag.UserName" == newUser ? "You have joined" : newUser + " has joined room";
                    $('#chatboard').append("<li class='joinedRoom'>" + name + " at " + getFormatedDate(new Date()) + "</li>")
                    $("#chatboard").scrollTop($('#chatboard')[0].scrollHeight)
                }
            }
            chat.client.leftRoom = function (onlineUsers, disconnectedUser) {
                var html = "";
                onlineUsers.forEach(function (name) {
                    html += '<li>' + name.UserName + '<span>joined at ' + name.ConnectionDateTime + '</span></li>';
                })

                $("#onlineUsers").html(html)
                if (disconnectedUser != null || disconnectedUser != undefined) {
                    $('#chatboard').append("<li class='leftRoom'>" + disconnectedUser + " has left room at " + getFormatedDate(new Date()) + "</li>")
                    $("#chatboard").scrollTop($('#chatboard')[0].scrollHeight)
                }
            }
            chat.client.sayWhoIsTyping = function (name) {
                if (name.indexOf("@ViewBag.UserName") != -1) {
                    name = "You are typing..."
                    $('#typing').html('<em>' + name + ' </em>');
                }
                else {
                    $('#typing').html('<em>' + name + ' </em>');
                }

                setTimeout(function () {
                    $('#typing').html('');
                }, 5000);
            };

            // Get the user name and store it to prepend to messages.
            $('#username').val("@ViewBag.UserName");
            // Set initial focus to message input box.

            $('#message').focus();

            $('#sendmessage').click(function () {
                // Call the Send method on the hub.
                if ($('#message').val() != "") {
                    var message = $('#message').val();
                    var richTextMessage = message.replace('\n', '<br />');
                    chat.server.send($('#username').val(), richTextMessage);
                    // Clear text box and reset focus for next comment.
                    $('#sendmessage').focus();
                    $('#message').val('');
                    setTimeout(function () {
                        $('#message').focus();
                        $('#typing').html('');
                    }, 100);
                    $("#chatboard").scrollTop($('#chatboard')[0].scrollHeight)
                }
            });

            $('#message').keydown(function (e) {
                if (e.which == 13) {
                    if (e.shiftKey != true) {
                        var encodedName = $('<div />').text($('#username').val()).html();
                        var encodedMsg = $('<div />').text($('#message').val()).html();
                        $('#sendmessage').click();
                    }
                }

                if (e.which == 8) {
                    var encodedName = $('<div />').text($('#username').val()).html();
                    chat.server.whoIsTyping(encodedName + " is erasing...");
                }
                else {
                    var encodedName = $('<div />').text($('#username').val()).html();
                    chat.server.whoIsTyping(encodedName + " is typing...");
                }
            });
            // Start the connection.
            $.connection.hub.start().done(function () {
                chat.server.onConnection($('#username').val());
            });
        });

        function getFormatedDate(date) {
            var hours = date.getHours();
            var minutes = date.getMinutes();
            var ampm = hours >= 12 ? 'PM' : 'AM   ';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            minutes = minutes < 10 ? '0' + minutes : minutes;
            var formatedDate = hours + ':' + minutes + '&nbsp;' + ampm;
            return formatedDate;
        }

        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }


    </script>
}